import { Discussion, EnhancedDiscussion } from '../engine/discussion.js';
import { ConsensusMetrics, isDynamicRoundsEnabled } from '../types/consensus.js';
import { createAIServiceFromEnv, AIMessage } from '../lib/aiService.js';
import { log } from '../lib/log.js';

export interface WriterConfig {
  language: string;
  timestamp: string;
  prompt: string;
  includeAcceptanceCriteria?: boolean;
}

export async function writeDiscussionMarkdown(
  discussion: Discussion | EnhancedDiscussion,
  config: WriterConfig
): Promise<string> {
  const { language, timestamp, prompt } = config;
  const isPortuguese = language === 'pt' || language === 'pt-BR';

  const lines: string[] = [];

  // Header
  lines.push(isPortuguese ? '# Discuss√£o da Mesa Redonda' : '# Roundtable Discussion');
  lines.push('');
  lines.push(`**${isPortuguese ? 'Data/Hora' : 'Timestamp'}:** ${timestamp}`);
  lines.push(`**${isPortuguese ? 'Prompt de Entrada' : 'Input Prompt'}:** ${prompt}`);
  lines.push(`**${isPortuguese ? 'Idioma' : 'Language'}:** ${language}`);
  lines.push('');

  // Executive Summary (new section before participants)
  lines.push(...await generateExecutiveSummary(discussion, isPortuguese));

  // Participants
  lines.push(`## ${isPortuguese ? 'Participantes' : 'Participants'}`);
  lines.push('');
  lines.push(isPortuguese 
    ? '| Nome | Papel | Objetivos |'
    : '| Name | Role | Objectives |'
  );
  lines.push('|------|------|------------|');

  for (const participant of discussion.participants) {
    const objectives = participant.objectives.slice(0, 2).join('; ');
    lines.push(`| ${participant.name} | ${participant.role} | ${objectives} |`);
  }
  lines.push('');

  // Discussion Rounds
  lines.push(`## ${isPortuguese ? 'Transcri√ß√£o da Discuss√£o' : 'Discussion Transcript'}`);
  lines.push('');

  let currentRound = 0;
  for (const turn of discussion.rounds) {
    if (turn.round !== currentRound) {
      currentRound = turn.round;
      lines.push(`### ${isPortuguese ? 'Rodada' : 'Round'} ${currentRound}`);
      lines.push('');
    }

    lines.push(`**${turn.speaker}** (${turn.role}):`);
    lines.push('');
    lines.push(`> ${turn.content}`);
    lines.push('');
  }

  // Decisions
  lines.push(`## ${isPortuguese ? 'Decis√µes e Justificativas' : 'Decisions & Rationale'}`);
  lines.push('');

  for (let i = 0; i < discussion.decisions.length; i++) {
    lines.push(`${i + 1}. ${discussion.decisions[i]}`);
  }
  lines.push('');

  // Next Steps
  lines.push(`## ${isPortuguese ? 'Pr√≥ximos Passos' : 'Next Steps'}`);
  lines.push('');

  for (let i = 0; i < discussion.nextSteps.length; i++) {
    lines.push(`${i + 1}. ${discussion.nextSteps[i]}`);
  }
  lines.push('');

  // Add consensus metrics if available (for enhanced discussions)
  if (isEnhancedDiscussion(discussion) && discussion.consensusHistory.length > 0) {
    lines.push(...generateConsensusSection(discussion, isPortuguese));
  }

  // Footer
  lines.push('---');
  lines.push('');
  lines.push(isPortuguese
    ? '*Documento gerado pelo PentaForge MCP Server*'
    : '*Document generated by PentaForge MCP Server*'
  );

  return lines.join('\n');
}

/**
 * Type guard to check if discussion is enhanced with consensus data
 */
function isEnhancedDiscussion(discussion: Discussion | EnhancedDiscussion): discussion is EnhancedDiscussion {
  return 'consensusHistory' in discussion && 'consensusReached' in discussion;
}

/**
 * Generates consensus metrics section for enhanced discussions
 */
function generateConsensusSection(discussion: EnhancedDiscussion, isPortuguese: boolean): string[] {
  const lines: string[] = [];
  
  // Consensus Overview
  lines.push(`## ${isPortuguese ? 'M√©tricas de Consenso' : 'Consensus Metrics'}`);
  lines.push('');
  
  const finalConsensus = discussion.consensusHistory[discussion.consensusHistory.length - 1];
  const isDynamic = isDynamicRoundsEnabled(discussion.config);
  
  if (isDynamic) {
    lines.push(`**${isPortuguese ? 'Modo' : 'Mode'}:** ${isPortuguese ? 'Rodadas Din√¢micas' : 'Dynamic Rounds'}`);
    lines.push(`**${isPortuguese ? 'Consenso Alcan√ßado' : 'Consensus Reached'}:** ${discussion.consensusReached ? (isPortuguese ? 'Sim' : 'Yes') : (isPortuguese ? 'N√£o' : 'No')}`);
    lines.push(`**${isPortuguese ? 'Total de Rodadas' : 'Total Rounds'}:** ${discussion.currentRound}`);
    
    if (finalConsensus) {
      lines.push(`**${isPortuguese ? 'Pontua√ß√£o Final de Acordo' : 'Final Agreement Score'}:** ${finalConsensus.agreementScore}%`);
      lines.push(`**${isPortuguese ? 'N√≠vel de Confian√ßa' : 'Confidence Level'}:** ${finalConsensus.confidenceLevel}%`);
      lines.push(`**${isPortuguese ? 'Fase da Discuss√£o' : 'Discussion Phase'}:** ${translatePhase(finalConsensus.discussionPhase, isPortuguese)}`);
    }
  } else {
    lines.push(`**${isPortuguese ? 'Modo' : 'Mode'}:** ${isPortuguese ? 'Rodadas Fixas (3 rodadas)' : 'Fixed Rounds (3 rounds)'}`);
    lines.push(`**${isPortuguese ? 'Consenso' : 'Consensus'}:** ${isPortuguese ? 'Assumido (compatibilidade)' : 'Assumed (compatibility)'}`);
  }
  
  lines.push('');
  
  // Consensus Evolution (only for dynamic rounds)
  if (isDynamic && discussion.consensusHistory.length > 1) {
    lines.push(`### ${isPortuguese ? 'Evolu√ß√£o do Consenso' : 'Consensus Evolution'}`);
    lines.push('');
    
    lines.push(isPortuguese 
      ? '| Rodada | Acordo (%) | Confian√ßa (%) | Quest√µes N√£o Resolvidas | Fase |'
      : '| Round | Agreement (%) | Confidence (%) | Unresolved Issues | Phase |'
    );
    lines.push('|--------|------------|---------------|----------------------|-------|');
    
    discussion.consensusHistory.forEach((metrics: any, index: number) => {
      const round = index + 1;
      const issuesCount = metrics.unresolvedIssues.length;
      const phase = translatePhase(metrics.discussionPhase, isPortuguese);
      lines.push(`| ${round} | ${metrics.agreementScore}% | ${metrics.confidenceLevel}% | ${issuesCount} | ${phase} |`);
    });
    
    lines.push('');
  }
  
  // Final State Analysis
  if (finalConsensus) {
    lines.push(`### ${isPortuguese ? 'An√°lise Final' : 'Final Analysis'}`);
    lines.push('');
    
    if (finalConsensus.unresolvedIssues.length > 0) {
      lines.push(`**${isPortuguese ? 'Quest√µes N√£o Resolvidas' : 'Unresolved Issues'}:**`);
      finalConsensus.unresolvedIssues.forEach((issue: string) => {
        lines.push(`- ${issue}`);
      });
      lines.push('');
    }
    
    if (finalConsensus.conflictingPositions.size > 0) {
      lines.push(`**${isPortuguese ? 'Posi√ß√µes Conflitantes' : 'Conflicting Positions'}:**`);
      finalConsensus.conflictingPositions.forEach((positions: string[], role: string) => {
        lines.push(`- **${role}:** ${positions.join(', ')}`);
      });
      lines.push('');
    }
    
    if (finalConsensus.unresolvedIssues.length === 0 && finalConsensus.conflictingPositions.size === 0) {
      lines.push(isPortuguese 
        ? `‚úÖ **Consenso Completo:** Todas as quest√µes foram resolvidas e n√£o h√° conflitos pendentes.`
        : `‚úÖ **Complete Consensus:** All issues resolved and no pending conflicts.`
      );
      lines.push('');
    }
  }
  
  return lines;
}

/**
 * Translates discussion phase to appropriate language
 */
function translatePhase(phase: ConsensusMetrics['discussionPhase'], isPortuguese: boolean): string {
  if (isPortuguese) {
    switch (phase) {
      case 'exploration': return 'Explora√ß√£o';
      case 'alignment': return 'Alinhamento';
      case 'resolution': return 'Resolu√ß√£o';
      case 'finalization': return 'Finaliza√ß√£o';
      default: return phase;
    }
  }

  // English - just capitalize first letter
  return phase.charAt(0).toUpperCase() + phase.slice(1);
}

/**
 * Generates executive summary section with decisions and alternatives using AI
 */
async function generateExecutiveSummary(discussion: Discussion | EnhancedDiscussion, isPortuguese: boolean): Promise<string[]> {
  const lines: string[] = [];

  // Section header
  lines.push(`## ${isPortuguese ? 'Resumo Executivo' : 'Executive Summary'}`);
  lines.push('');

  try {
    // Use AI to generate comprehensive summary
    const aiSummary = await generateAISummary(discussion, isPortuguese);
    lines.push(aiSummary);
    lines.push('');
  } catch (error) {
    log.warn(`‚ö†Ô∏è Failed to generate AI summary, using fallback: ${error}`);

    // Fallback to basic summary
    const totalRounds = discussion.rounds.length > 0 ? Math.max(...discussion.rounds.map(r => r.round)) : 0;
    const participantCount = discussion.participants.length;
    const decisionCount = discussion.decisions.length;

    if (isPortuguese) {
      lines.push(`A discuss√£o envolveu ${participantCount} participantes ao longo de ${totalRounds} rodadas, resultando em ${decisionCount} decis√µes principais.`);
    } else {
      lines.push(`The discussion involved ${participantCount} participants across ${totalRounds} rounds, resulting in ${decisionCount} key decisions.`);
    }
    lines.push('');
  }

  return lines;
}

/**
 * Uses AI to generate comprehensive executive summary from discussion
 */
async function generateAISummary(discussion: Discussion | EnhancedDiscussion, isPortuguese: boolean): Promise<string> {
  // Create AI service with higher token limit for detailed summary
  const aiService = createAIServiceFromEnv();
  // Override maxTokens for summary generation
  (aiService as any).config.maxTokens = 1500;

  // Build discussion context for AI
  const discussionTranscript = discussion.rounds
    .map(turn => `[Round ${turn.round}] ${turn.role}: ${turn.content}`)
    .join('\n\n');

  const finalDecisions = discussion.decisions.join('\n- ');
  const nextSteps = discussion.nextSteps.join('\n- ');

  const systemPrompt = isPortuguese
    ? `Voc√™ √© um analista especializado em resumir discuss√µes t√©cnicas de equipes de desenvolvimento.

Sua tarefa √© analisar a transcri√ß√£o completa de uma discuss√£o em roundtable e gerar um resumo executivo DETALHADO que mostre:

1. **Vis√£o Geral**: Resumo em 2-3 frases do que foi discutido e do contexto geral

2. **Decis√µes Tomadas e Alternativas Consideradas**: Para CADA decis√£o t√©cnica ou de neg√≥cio:
   - Identifique a DECIS√ÉO FINAL (tecnologia, abordagem, padr√£o escolhido)
   - Liste as ALTERNATIVAS que foram consideradas mas descartadas
   - Explique a JUSTIFICATIVA de por que a op√ß√£o final foi escolhida
   - Documente por que as alternativas foram descartadas

Formato esperado:

### Vis√£o Geral
[Resumo geral da discuss√£o]

### Decis√µes Tomadas e Alternativas Consideradas

#### 1. [T√≥pico da Decis√£o - ex: "Message Broker", "Autentica√ß√£o", "Arquitetura"]
**Decis√£o Final:** [Tecnologia/abordagem escolhida]
**Justificativa:** [Por que foi escolhida - extra√≠do das falas dos participantes]
**Alternativas Consideradas e Descartadas:**
- **[Alternativa 1]**: [Por que foi descartada - extra√≠do das falas]
- **[Alternativa 2]**: [Por que foi descartada - extra√≠do das falas]

#### 2. [Pr√≥xima decis√£o...]

IMPORTANTE:
- Use APENAS informa√ß√µes presentes na transcri√ß√£o
- Cite as tecnologias/abordagens EXATAMENTE como mencionadas
- Extraia justificativas REAIS das falas dos participantes, n√£o invente
- Se uma alternativa foi mencionada mas n√£o teve motivo de descarte expl√≠cito, diga "n√£o atendeu aos requisitos espec√≠ficos"
- Seja ESPEC√çFICO e DETALHADO, evite generalidades`
    : `You are an analyst specialized in summarizing technical team discussions.

Your task is to analyze the complete transcript of a roundtable discussion and generate a DETAILED executive summary that shows:

1. **Overview**: 2-3 sentence summary of what was discussed and general context

2. **Decisions Made and Alternatives Considered**: For EACH technical or business decision:
   - Identify the FINAL DECISION (technology, approach, pattern chosen)
   - List the ALTERNATIVES that were considered but discarded
   - Explain the RATIONALE for why the final option was chosen
   - Document why alternatives were discarded

Expected format:

### Overview
[General discussion summary]

### Decisions Made and Alternatives Considered

#### 1. [Decision Topic - e.g., "Message Broker", "Authentication", "Architecture"]
**Final Decision:** [Chosen technology/approach]
**Rationale:** [Why it was chosen - extracted from participant statements]
**Alternatives Considered and Discarded:**
- **[Alternative 1]**: [Why it was discarded - extracted from statements]
- **[Alternative 2]**: [Why it was discarded - extracted from statements]

#### 2. [Next decision...]

IMPORTANT:
- Use ONLY information present in the transcript
- Cite technologies/approaches EXACTLY as mentioned
- Extract REAL justifications from participant statements, don't invent
- If an alternative was mentioned but no explicit discard reason, say "did not meet specific requirements"
- Be SPECIFIC and DETAILED, avoid generalities`;

  const userPrompt = isPortuguese
    ? `Analise esta discuss√£o e gere o resumo executivo conforme instru√≠do:

TRANSCRI√á√ÉO DA DISCUSS√ÉO:
${discussionTranscript}

DECIS√ïES FINAIS DOCUMENTADAS:
- ${finalDecisions}

PR√ìXIMOS PASSOS:
- ${nextSteps}

Gere agora o resumo executivo completo em markdown:`
    : `Analyze this discussion and generate the executive summary as instructed:

DISCUSSION TRANSCRIPT:
${discussionTranscript}

FINAL DECISIONS DOCUMENTED:
- ${finalDecisions}

NEXT STEPS:
- ${nextSteps}

Now generate the complete executive summary in markdown:`;

  const messages: AIMessage[] = [
    { role: 'system', content: systemPrompt },
    { role: 'user', content: userPrompt }
  ];

  log.info('ü§ñ Generating AI-powered executive summary...');
  const response = await aiService.generateResponse(messages);
  log.info('‚úÖ Executive summary generated successfully');

  return response.content;
}